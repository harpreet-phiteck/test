<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Draw Color Change Example</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!-- <script src='./test.js'></script> -->

<script src='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css' rel='stylesheet' />

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <!-- <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' /> -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css">
    <link href='https://watergis.github.io/mapbox-gl-export/mapbox-gl-export.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <style>
    /* body {
        margin: 0;
        padding: 0;
        background-color: #e5e5e5;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        margin: 10px auto;
    /* position: relative; */
    /* margin-left: 39px;
    }

    canvas.mapboxgl-canvas{
        min-width: 470px;
    max-width: 480px !important;
    max-height: 554px;
    margin-left: 20px;
    margin-top: 20px;
    z-index: 4;
    }
    button.mapboxgl-ctrl-icon.mapboxgl-export-control, button.mapboxgl-ctrl-attrib-button,.mapboxgl-ctrl-bottom-left{
        display: none !important;
    } */ */
    </style>
</head>

<body>
    
    <h1>Overlay text on canvas image and save as base64</h1>
    <div class="page-wrap">
      <div class="controls">
        <input class="controls__input" type="file" id="imageLoader" name="imageLoader"/>
        <label class="controls__label" for="name">First, choose an image.</label>
        
        <input class="controls__input" id="name" type="text" value=""/>
        <label class="controls__label" for="name">Overlay Text</label>
      </div>
      <div id="canvas-wrap">

      </div>
      
    </div>
    
    
    
    
    
    
    



    <style>
    /* #black-color,
    #red-color,
    #green-color {
        z-index: 1005;
        position: absolute;
        right: 5px;
        color: white;
    }

    #black-color {
        top: 10px;
        background-color: black;
    }

    #red-color {
        top: 35px;
        background-color: red;
    }

    #green-color {
        top: 60px;
        background-color: green;
    }
    .map-overlay.top{
        position: absolute;
        z-index: 54650;
    }
    .coordinates {
background: rgba(0, 0, 0, 0.5);
color: #fff;
position: absolute;
bottom: 40px;
left: 10px;
padding: 5px 10px;
margin: 0;
font-size: 11px;
line-height: 18px;
border-radius: 3px;
display: none; */
/* } */
    </style>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.4/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.4/mapbox-gl-draw.css' type='text/css' />
 <div class="row p-4" >
     <div class="col-md-7 p-4">
    <div id='map' style="    width: 492px;
    height: 603px;margin:10px auto;overflow: inherit;">

 
<canvas style="display: block;
margin: auto;
height: 747px;
max-width: 520px;
max-height: 735px;
position: absolute;
z-index: 2;
left: 0px;" id="imageCanvas" class="shadow" width=1056px height=1493px>
    <canvas id="canvasID"></canvas>
</canvas>    
    </div>
</div>
<div class="col-md-5 p-4">


    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <div id="geocoder" class="geocoder"></div>
            <fieldset>
                <label>Select layer</label>
                <select id="layer" name="layer">
                    <!-- Each value matches a layer ID. -->
                    <option value="water">Water</option>
                    <option value="building">Buildings</option>
                    <option value="land">land</option>
                    <option value="road-primary" selected>Road</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Choose a color</label>
                <div id="swatches"></div>
            </fieldset>
        </div>
    <div id="menu">
        <input id="satellite-v9" type="radio" name="rtoggle" value="satellite" checked="checked">
        <!-- See a list of Mapbox-hosted public styles at -->
        <!-- https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
        <label for="satellite-v9">satellite</label>
        <input id="light-v10" type="radio" name="rtoggle" value="light">
        <label for="light-v10">light</label>
        <input id="dark-v10" type="radio" name="rtoggle" value="dark">
        <label for="dark-v10">dark</label>
        <input id="streets-v11" type="radio" name="rtoggle" value="streets">
        <label for="streets-v11">streets</label>
        <input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors">
        <label for="outdoors-v11">outdoors</label>
        <!-- <input id="satellite-streets-v11" type="radio" name="rtoggle" value="satellite-streets-v11">
        <label for="satellite-streets-v11">satellite-streets-v11</label> -->
        <input id="navigation-day-v1" type="radio" name="rtoggle" value="navigation-day-v1">
        <label for="navigation-day-v1">navigation-day-v1</label>
        <input id="navigation-night-v1" type="radio" name="rtoggle" value="navigation-night-v1">
        <label for="navigation-night-v1">navigation-night-v1</label>
    </div>
    

</div>
</div>
</div>
<canvas width="3168" height="4479" id="canvas-total" style="display: none;"></canvas>
    <pre id="coordinates" class="coordinates"></pre>

    <input type="hidden" id="curLat">
    <input type="hidden" id="curLng">
    <input type="hidden" id="state">

    <script src="js/export.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js" integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script type="text/javascript">
    var text_title ="Overlay text";
    var imageLoader = document.getElementById('imageLoader');
        imageLoader.addEventListener('change', handleImage, false);
    var canvas = document.getElementById('imageCanvas');
    var ctx = canvas.getContext('2d');
    var img = new Image();
    img.crossOrigin="anonymous";
    
    window.addEventListener('load', DrawPlaceholder)
    
    function DrawPlaceholder() {
        // img.onload = function() {
        //     DrawOverlay(img);
        //     DrawText();
        //     DynamicText(img)
        // };
        // img.src = 'https://unsplash.it/3440/4386/?random';
        DrawOverlay();
            DrawText('mohali');
            DynamicText('mohali');
    }
    function DrawOverlay() {
        ctx.drawImage(img,0,0);
        ctx.fillStyle = 'rgba(255, 255, 255, 1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height*2);
        ctx.clearRect(40, 40, canvas.width/1.1, canvas.height/1.35);
        
        // ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    function DrawText(text_title, state, latlng) {
        ctx.fillStyle = "white";
        // ctx.textBaseline = 'middle';
        ctx.textAlign = "center";
        ctx.fillStyle = "#000000";
        ctx.font = "90px 'Montserrat'";
        ctx.fillText(text_title, 1056/2, 1410/1.1);

        ctx.font = "42px 'Montserrat'";
ctx.fillText(state, 1056/2, 1475/1.1);

ctx.font = "30px 'Montserrat'";
ctx.fillText(latlng, 1056/2, 1530/1.1);
    }
    function DynamicText(value, state, latlng) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        DrawOverlay();
        DrawText(value, state, latlng); 
//         text_title = value;
//         ctx.fillText(text_title, 1056/2, 1390/1.1);

//         ctx.font = "40px 'Montserrat'";
// ctx.fillText(state, 1056/2, 1440/1.1);

// ctx.font = "25px 'Montserrat'";
// ctx.fillText(latlng, 1056/2, 1480/1.1);
    }
    function handleImage(e) {
        var reader = new FileReader();
        var img = "";
        var src = "";
        reader.onload = function(event) {
            img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img,0,0);
            }
            img.src = event.target.result;
            src = event.target.result;
            canvas.classList.add("show");
            DrawOverlay(img);
            DrawText(); 
            DynamicText(img);   
        }
    
        reader.readAsDataURL(e.target.files[0]); 
     
    }
    function convertToImage() {
        window.open(canvas.toDataURL('png'));
    }
    document.getElementById('download').onclick = function download() {
            convertToImage();
    }
    
    
    
    </script>
    
  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FyYW5nMHlhbCIsImEiOiJja2VlaG42eDUwZnppMnlveXJtcjdvOGtvIn0.KoPWjGAkfBFhFBEuSUinlw';

    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/light-v10', //hosted style id
        zoom: 13,
        center: [-80.19125409514797, 25.78075907018487],
        preserveDrawingBuffer: true
    });


    const layerList = document.getElementById('menu');
    const inputs = layerList.getElementsByTagName('input');

    for (const input of inputs) {
        input.onclick = (layer) => {
            const layerId = layer.target.id;
            console.log(layer.target.id)
            map.setStyle('mapbox://styles/mapbox/' + layerId);

        };
    }
    map.on('load', () => {
        map.setPaintProperty('land', 'background-color', '#ffffff');
        map.setPaintProperty('water', 'fill-color', '#9BBCD9');
        map.setPaintProperty('building', 'fill-color', '#ffffcc');
        document.getElementById('id11').click()
    });

    const swatches = document.getElementById('swatches');
    const layer = document.getElementById('layer');
    const colors = [
        '#ffffcc',
        '#a1dab4',
        '#41b6c4',
        '#2c7fb8',
        '#253494',
        '#fed976',
        '#feb24c',
        '#fd8d3c',
        '#f03b20',
        '#bd0026',
        '#FFFFFF',
        '#000000',
        '#9BBCD9'
    ];

    map.addControl(new watergis.MapboxExportControl({
      PageSize: watergis.Size.A3,
      PageOrientation: watergis.PageOrientation.Portrait,
      Format: watergis.Format.PNG,
      DPI: watergis.DPI[300],
      Crosshair: true,
      PrintableArea: true,
  }), 'top-right');
var i = 0;
    for (const color of colors) {
        const swatch = document.createElement('button');
        swatch.id = 'id'+i++
        swatch.style.backgroundColor = color;
        swatch.addEventListener('click', () => {
            if(layer.value == 'land'){
                map.setPaintProperty(layer.value, 'background-color', color);
            }else if(layer.value == 'road-primary'){
                map.setPaintProperty('road-primary', 'line-color', color);
                map.setPaintProperty('road-secondary-tertiary', 'line-color', color);
                map.setPaintProperty('road-motorway-trunk', 'line-color', color);
                map.setPaintProperty('road-minor', 'line-color', color);
                map.setPaintProperty('road-path', 'line-color', color);
                map.setPaintProperty('road-street', 'line-color', color);
                map.setPaintProperty('road-street-low', 'line-color', color);
                map.setPaintProperty('bridge-primary-secondary-tertiary', 'line-color', color);
                

            }
            else{
            map.setPaintProperty(layer.value, 'fill-color', color);
        }
        });
        swatches.appendChild(swatch);
    }

       // Add the control to the map.
       const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        zoom: 13
    });

    const marker = new mapboxgl.Marker({
        draggable: true
    })
 
    function onDragEnd() {
        const lngLat = marker.getLngLat();
        coordinates.style.display = 'block';
        coordinates.innerHTML = `Longitude: ${lngLat.lng}<br />Latitude: ${lngLat.lat}`;
    }

    function toDegreesMinutesAndSeconds(e) {
        var t = Math.abs(e)
          , a = Math.floor(t)
          , r = 60 * (t - a)
          , o = Math.floor(r)
          , i = Math.floor(60 * (r - o));
        return a + String.fromCharCode(176) + " " + o + "' " + i + "\""
    }
    function convertDMS(e, t) {
        var a = toDegreesMinutesAndSeconds(e)
          , r = 0 <= e ? "N" : "S"
          , o = toDegreesMinutesAndSeconds(t)
          , i = 0 <= t ? "E" : "W";
        geoPoint = a + " " + r + "   " + o + " " + i,
        propertyGeoPoint = a + " " + r + ";" + o + " " + i,
        document.getElementById("curLat").value = e,
        document.getElementById("curLng").value = t

        return geoPoint;
    }
 
marker.on('dragend', onDragEnd);

    geocoder.on('result', e => {
        console.log(e.result);
        console.log(e.result.place_name.split(', ').splice(-1,1)[0])
        DynamicText(e.result.text.toUpperCase(), e.result.place_name.split(', ').splice(-1,1)[0].toUpperCase(), convertDMS(e.result.center[0], e.result.center[1])) 
        map.setCenter(e.result.center)
        marker.setLngLat(e.result.center).addTo(map);
        map.setZoom(13)
        map.loadImage(
      	'https://docs.mapbox.com/mapbox-gl-js/assets/cat.png',
      	(error, image) => {
      		if (error) throw error;

      		// Add the image to the map style.
      		map.addImage('cat', image);

      		// Add a data source containing one point feature.
      		map.addSource('point', {
      			'type': 'geojson',
      			'data': {
      				'type': 'FeatureCollection',
      				'features': [{
      					'type': 'Feature',
      					'geometry': {
      						'type': 'Point',
      						'coordinates': e.result.center
      					}
      				}]
      			}
      		});

      		// Add a layer to use the image to represent the data.
      		map.addLayer({
      			'id': 'points',
      			'type': 'symbol',
      			'source': 'point', // reference the data source
      			'layout': {
      				'icon-image': 'cat', // reference the image
      				'icon-size': 0.15
      			}
      		});
      	}
      );
    });

    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));


    function setDPI(canvas, dpi) {
    // Set up CSS size.
    canvas.style.width = canvas.style.width || canvas.width + 'px';
    canvas.style.height = canvas.style.height || canvas.height + 'px';

    // Get size information.
    var scaleFactor = dpi / 96;
    var width = parseFloat(canvas.width);
    var height = parseFloat(canvas.height);

    // Backup the canvas contents.
    var oldScale = canvas.width / width;
    var backupScale = scaleFactor / oldScale;
    var backup = canvas.cloneNode(false);
    backup.getContext('2d').drawImage(canvas, 0, 0);

    // Resize the canvas.
    var ctx = canvas.getContext('2d');
    canvas.width = Math.ceil(width * scaleFactor);
    canvas.height = Math.ceil(height * scaleFactor);

    // Redraw the canvas image and scale future draws.
    ctx.setTransform(backupScale, 0, 0, backupScale, 0, 0);
    ctx.drawImage(backup, 0, 0);
    ctx.setTransform(scaleFactor, 0, 0, scaleFactor, 0, 0);
      
      var link = document.createElement('a');
      link.download = 'filename.png';
      link.href = document.getElementById('canvas-total').toDataURL()
      link.click()


}


var imagesLoaded = 0;
var img1, img2 = ''
    function download() {
//         Object.defineProperty(window, 'devicePixelRatio', {
//     get: function() {return dpi / 300}
// });
imagesLoaded = 0;
Object.defineProperty(window, 'devicePixelRatio', {
    get: function() {return 400 / 96}
});


img1 = loadImage(document.getElementById("imageCanvas").toDataURL("image/png").replace("image/png", "image/octet-stream"), main);
img2 = loadImage(document.getElementsByClassName("mapboxgl-canvas")[0].toDataURL("image/png").replace("image/png", "image/octet-stream"), main);


// var download = document.getElementById("download");
// var image = document.getElementsByClassName("mapboxgl-canvas")[0].toDataURL("image/png").replace("image/png", "image/octet-stream");
// download.setAttribute("href", image);
// download.click()
//download.setAttribute("download","archive.png");
}

function main() {
    imagesLoaded += 1;


var canvas = document.getElementById("canvas-total");
var ctx = canvas.getContext("2d");
    if(imagesLoaded == 2) {
        // composite now
        ctx.drawImage(img1, 0, 0, canvas.width, canvas.height);
        
        ctx.globalAlpha = 1;
        ctx.drawImage(img2, 40*3, 40*3, canvas.width/1.085, canvas.height/1.35);
        setDPI(document.getElementById('canvas-total'),150)
    }
}

function loadImage(src, onload) {
    // http://www.thefutureoftheweb.com/blog/image-onload-isnt-being-called
    var img = new Image();
    
    img.onload = onload;
    img.src = src;

    return img;
}

    </script>
<a id="download" download="triangle.png">
    <button type="button" onClick="download()">Download</button>
    </a>
        
</body>

</html>